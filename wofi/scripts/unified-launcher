#!/bin/bash
# ~/.config/wofi/scripts/unified-launcher
# Wofi inteligente que hace todo: apps instaladas + bÃºsqueda + instalaciÃ³n con iconos

create_unified_list() {
    # Archivo temporal para la lista completa
    temp_file="/tmp/wofi_unified_list"
    
    # Limpiar archivo anterior
    > "$temp_file"
    
    echo "=== APLICACIONES INSTALADAS ===" >> "$temp_file"
    
    # Obtener aplicaciones instaladas desde .desktop files
    find /usr/share/applications ~/.local/share/applications -name "*.desktop" 2>/dev/null | while read desktop_file; do
        if [[ -f "$desktop_file" ]]; then
            # Extraer nombre, descripciÃ³n e icono
            name=$(grep "^Name=" "$desktop_file" | grep -v "Name\[" | head -1 | cut -d'=' -f2)
            comment=$(grep "^Comment=" "$desktop_file" | grep -v "Comment\[" | head -1 | cut -d'=' -f2)
            icon=$(grep "^Icon=" "$desktop_file" | head -1 | cut -d'=' -f2)
            exec_cmd=$(grep "^Exec=" "$desktop_file" | head -1 | cut -d'=' -f2)
            
            if [[ -n "$name" && -n "$exec_cmd" ]]; then
                # Formato: Nombre - DescripciÃ³n\0icon\0nombre_icono
                if [[ -n "$comment" ]]; then
                    echo -e "$name - $comment\0icon\0$icon" >> "$temp_file"
                else
                    echo -e "$name\0icon\0$icon" >> "$temp_file"
                fi
            fi
        fi
    done
    
    # Separador y opciones de bÃºsqueda/instalaciÃ³n con iconos predefinidos
    echo "" >> "$temp_file"
    echo "=== HERRAMIENTAS ===" >> "$temp_file"
    echo -e "ğŸ” Buscar aplicaciÃ³n para instalar\0icon\0system-search" >> "$temp_file"
    echo -e "ğŸ“¦ Instalar desde repositorios (pacman)\0icon\0package-x-generic" >> "$temp_file"
    echo -e "ğŸ”¶ Instalar desde AUR (yay)\0icon\0package-x-generic" >> "$temp_file"
    echo -e "â­ Apps populares (instalaciÃ³n rÃ¡pida)\0icon\0starred" >> "$temp_file"
    echo -e "ğŸ’» Abrir terminal\0icon\0terminal" >> "$temp_file"
    echo -e "ğŸ”§ Ejecutar comando personalizado\0icon\0system-run" >> "$temp_file"
    echo -e "ğŸ“‹ GestiÃ³n de paquetes\0icon\0package-x-generic" >> "$temp_file"
    
    echo "$temp_file"
}

# FunciÃ³n para ejecutar aplicaciÃ³n instalada
launch_app() {
    local app_line="$1"
    # Extraer solo el nombre de la app (quitar descripciÃ³n e icono)
    app_name=$(echo "$app_line" | sed 's/ - .*//' | sed 's/\x0.*//')
    
    # Buscar el archivo .desktop correspondiente
    desktop_file=$(find /usr/share/applications ~/.local/share/applications -name "*.desktop" -exec grep -l "^Name=$app_name$" {} \; 2>/dev/null | head -1)
    
    if [[ -n "$desktop_file" ]]; then
        # Obtener comando de ejecuciÃ³n
        exec_cmd=$(grep "^Exec=" "$desktop_file" | head -1 | cut -d'=' -f2 | sed 's/%[a-zA-Z]//g')
        notify-send "Lanzando" "$app_name"
        eval "$exec_cmd" &
    else
        # Intentar ejecutar directamente por nombre
        if command -v "$app_name" >/dev/null 2>&1; then
            "$app_name" &
        else
            notify-send "Error" "No se pudo ejecutar $app_name"
        fi
    fi
}

# FunciÃ³n de bÃºsqueda e instalaciÃ³n
search_and_install() {
    search_term=$(echo "" | wofi --dmenu --prompt="ğŸ” Buscar app: " --width=400 --cache-file=/dev/null)
    
    if [[ -n "$search_term" ]]; then
        # Crear menÃº de opciones de bÃºsqueda
        search_options="ğŸ“¦ Buscar en repositorios oficiales (pacman)\0icon\0package-x-generic
ğŸ”¶ Buscar en AUR (yay)\0icon\0package-x-generic
ğŸš€ Verificar si estÃ¡ instalado\0icon\0system-search
âŒ Cancelar\0icon\0process-stop"
        
        choice=$(echo -e "$search_options" | wofi --dmenu --prompt="Buscar '$search_term' en:" --width=450 --cache-file=/dev/null)
        
        case "$choice" in
            *"repositorios oficiales"*)
                search_pacman "$search_term"
                ;;
            *"AUR"*)
                search_aur "$search_term"
                ;;
            *"estÃ¡ instalado"*)
                check_installed "$search_term"
                ;;
        esac
    fi
}

# Buscar en repositorios oficiales
search_pacman() {
    local term="$1"
    notify-send "Buscando..." "Buscando '$term' en repositorios oficiales..."
    
    # Crear lista de resultados
    pacman -Ss "$term" 2>/dev/null | grep -E '^[a-zA-Z0-9]' | head -15 > /tmp/pacman_search
    
    if [[ -s /tmp/pacman_search ]]; then
        # Formatear para wofi con icono genÃ©rico
        {
            echo "=== RESULTADOS EN REPOSITORIOS OFICIALES ==="
            sed 's/^/ğŸ“¦ /' /tmp/pacman_search | while read line; do
                echo -e "$line\0icon\0package-x-generic"
            done
            echo ""
            echo -e "ğŸ”„ Nueva bÃºsqueda\0icon\0system-search"
            echo -e "âŒ Volver al menÃº principal\0icon\0process-stop"
        } > /tmp/formatted_pacman
        
        selection=$(cat /tmp/formatted_pacman | wofi --dmenu --prompt="Instalar: " --width=700 --height=400 --cache-file=/dev/null)
        
        if [[ "$selection" =~ ^ğŸ“¦ ]]; then
            # Extraer nombre del paquete
            package=$(echo "$selection" | sed 's/^ğŸ“¦ //' | awk '{print $1}' | sed 's/\x0.*//')
            install_package "$package" "pacman"
        elif [[ "$selection" == *"Nueva bÃºsqueda"* ]]; then
            search_and_install
        fi
    else
        notify-send "Sin resultados" "No se encontrÃ³ '$term' en repositorios oficiales"
        # Ofrecer buscar en AUR
        aur_search=$(echo -e "ğŸ”¶ Buscar '$term' en AUR\0icon\0package-x-generic\nâŒ Volver\0icon\0process-stop" | wofi --dmenu --prompt="Â¿Buscar en AUR?" --width=300 --cache-file=/dev/null)
        if [[ "$aur_search" =~ AUR ]]; then
            search_aur "$term"
        fi
    fi
    
    rm -f /tmp/pacman_search /tmp/formatted_pacman
}

# Buscar en AUR
search_aur() {
    local term="$1"
    notify-send "Buscando..." "Buscando '$term' en AUR..."
    
    yay -Ss "$term" 2>/dev/null | grep -E '^aur/' | head -10 > /tmp/aur_search
    
    if [[ -s /tmp/aur_search ]]; then
        {
            echo "=== RESULTADOS EN AUR ==="
            sed 's/^/ğŸ”¶ /' /tmp/aur_search | while read line; do
                echo -e "$line\0icon\0package-x-generic"
            done
            echo ""
            echo -e "ğŸ”„ Nueva bÃºsqueda\0icon\0system-search"
            echo -e "âŒ Volver al menÃº principal\0icon\0process-stop"
        } > /tmp/formatted_aur
        
        selection=$(cat /tmp/formatted_aur | wofi --dmenu --prompt="Instalar desde AUR: " --width=700 --height=400 --cache-file=/dev/null)
        
        if [[ "$selection" =~ ^ğŸ”¶ ]]; then
            package=$(echo "$selection" | sed 's/^ğŸ”¶ aur\///' | awk '{print $1}' | sed 's/\x0.*//')
            install_package "$package" "aur"
        elif [[ "$selection" == *"Nueva bÃºsqueda"* ]]; then
            search_and_install
        fi
    else
        notify-send "Sin resultados" "No se encontrÃ³ '$term' en AUR"
    fi
    
    rm -f /tmp/aur_search /tmp/formatted_aur
}

# Verificar si estÃ¡ instalado
check_installed() {
    local term="$1"
    
    if command -v "$term" >/dev/null 2>&1; then
        action=$(echo -e "ğŸš€ Ejecutar $term\0icon\0system-run\nğŸ“ Ver informaciÃ³n del paquete\0icon\0info\nâŒ Volver\0icon\0process-stop" | wofi --dmenu --prompt="'$term' estÃ¡ instalado:" --width=300 --cache-file=/dev/null)
        
        case "$action" in
            *"Ejecutar"*) "$term" & ;;
            *"informaciÃ³n"*) 
                kitty -e bash -c "pacman -Qi $term 2>/dev/null || yay -Qi $term 2>/dev/null || echo 'Paquete no encontrado'; read" ;;
        esac
    else
        notify-send "No instalado" "'$term' no estÃ¡ instalado"
        search_and_install
    fi
}

# Instalar paquete
install_package() {
    local package="$1"
    local source="$2"
    
    confirm=$(echo -e "âœ… SÃ­, instalar $package\0icon\0dialog-ok\nâŒ No, cancelar\0icon\0process-stop" | wofi --dmenu --prompt="Â¿Instalar $package?" --width=350 --cache-file=/dev/null)
    
    if [[ "$confirm" =~ ^âœ… ]]; then
        if [[ "$source" == "pacman" ]]; then
            kitty -e bash -c "echo 'Instalando $package...'; sudo pacman -S $package; echo 'InstalaciÃ³n completada. Presiona Enter...'; read"
        else
            kitty -e bash -c "echo 'Instalando $package desde AUR...'; yay -S $package; echo 'InstalaciÃ³n completada. Presiona Enter...'; read"
        fi
        
        # Preguntar si quiere ejecutar la app despuÃ©s de instalar
        run_after=$(echo -e "ğŸš€ Ejecutar $package ahora\0icon\0system-run\nâŒ Volver al menÃº\0icon\0process-stop" | wofi --dmenu --prompt="Â¿Ejecutar despuÃ©s de instalar?" --width=300 --cache-file=/dev/null)
        
        if [[ "$run_after" =~ ^ğŸš€ ]]; then
            sleep 2  # Esperar a que termine la instalaciÃ³n
            "$package" &
        fi
    fi
}

# Apps populares para instalaciÃ³n rÃ¡pida
popular_apps() {
    popular="ğŸŒ firefox - Navegador web\0icon\0firefox
ğŸ“ code - Visual Studio Code\0icon\0visual-studio-code
ğŸµ spotify - Reproductor de mÃºsica\0icon\0spotify
ğŸ’¬ discord - Chat y comunicaciÃ³n\0icon\0discord
ğŸ® steam - Plataforma de juegos\0icon\0steam
ğŸ“º vlc - Reproductor multimedia\0icon\0vlc
ğŸ–¼ï¸ gimp - Editor de imÃ¡genes\0icon\0gimp
âš¡ obs-studio - Software de streaming\0icon\0obs
ğŸ“Š libreoffice-fresh - Suite de oficina\0icon\0libreoffice
ğŸ–¥ï¸ htop - Monitor del sistema\0icon\0htop
ğŸ”§ gparted - Editor de particiones\0icon\0gparted
ğŸ“ thunar - Gestor de archivos\0icon\0thunar
ğŸŒ chromium - Navegador Chromium\0icon\0chromium
ğŸ¨ inkscape - Editor vectorial\0icon\0inkscape
ğŸ“¸ flameshot - Capturas de pantalla\0icon\0flameshot
âŒ Volver al menÃº principal\0icon\0process-stop"

    choice=$(echo -e "$popular" | wofi --dmenu --prompt="Apps populares: " --width=500 --height=450 --cache-file=/dev/null)
    
    if [[ "$choice" != *"Volver"* && "$choice" != *"âŒ"* ]]; then
        # Extraer comando de instalaciÃ³n
        case "$choice" in
            *"firefox"*) install_package "firefox" "pacman" ;;
            *"code"*) install_package "visual-studio-code-bin" "aur" ;;
            *"spotify"*) install_package "spotify" "aur" ;;
            *"discord"*) install_package "discord" "pacman" ;;
            *"steam"*) install_package "steam" "pacman" ;;
            *"vlc"*) install_package "vlc" "pacman" ;;
            *"gimp"*) install_package "gimp" "pacman" ;;
            *"obs-studio"*) install_package "obs-studio" "pacman" ;;
            *"libreoffice"*) install_package "libreoffice-fresh" "pacman" ;;
            *"htop"*) install_package "htop" "pacman" ;;
            *"gparted"*) install_package "gparted" "pacman" ;;
            *"thunar"*) install_package "thunar" "pacman" ;;
            *"chromium"*) install_package "chromium" "pacman" ;;
            *"inkscape"*) install_package "inkscape" "pacman" ;;
            *"flameshot"*) install_package "flameshot" "pacman" ;;
        esac
    fi
}

# GestiÃ³n de paquetes
package_management() {
    mgmt_options="ğŸ”„ Actualizar sistema (pacman -Syu)\0icon\0system-software-update
ğŸ—‘ï¸ Limpiar cache de paquetes\0icon\0edit-clear
ğŸ“‹ Ver paquetes instalados recientemente\0icon\0package-x-generic
ğŸ” Buscar paquetes huÃ©rfanos\0icon\0system-search
â¬‡ï¸ Ver paquetes instalados desde AUR\0icon\0package-x-generic
âŒ Volver al menÃº principal\0icon\0process-stop"

    choice=$(echo -e "$mgmt_options" | wofi --dmenu --prompt="GestiÃ³n de paquetes: " --width=400 --cache-file=/dev/null)
    
    case "$choice" in
        *"Actualizar sistema"*)
            kitty -e bash -c "echo 'Actualizando sistema...'; sudo pacman -Syu; echo 'ActualizaciÃ³n completada. Presiona Enter...'; read"
            ;;
        *"Limpiar cache"*)
            kitty -e bash -c "echo 'Limpiando cache...'; sudo pacman -Sc; echo 'Cache limpiado. Presiona Enter...'; read"
            ;;
        *"instalados recientemente"*)
            kitty -e bash -c "echo 'Paquetes instalados en los Ãºltimos 7 dÃ­as:'; pacman -Qq | xargs pacman -Qi | grep -E '^Name|^Install Date' | paste - - | grep \$(date -d '7 days ago' '+%Y-%m-%d') | head -20; read"
            ;;
        *"huÃ©rfanos"*)
            kitty -e bash -c "echo 'Paquetes huÃ©rfanos:'; pacman -Qtdq; echo 'Para eliminar: sudo pacman -Rs \$(pacman -Qtdq)'; read"
            ;;
        *"desde AUR"*)
            kitty -e bash -c "echo 'Paquetes instalados desde AUR:'; pacman -Qm; read"
            ;;
    esac
}

# FunciÃ³n principal
main() {
    # Crear lista unificada
    list_file=$(create_unified_list)
    
    # Mostrar menÃº principal con wofi, habilitando iconos
    selection=$(cat "$list_file" | wofi --dmenu --prompt="Launcher ğŸš€: " --width=600 --height=500 --allow-images)
    
    # Procesar selecciÃ³n
    if [[ "$selection" =~ ^=== || "$selection" == "" ]]; then
        exit 0
    fi
    
    # Remover el sufijo de icono para procesar la selecciÃ³n
    selection_clean=$(echo "$selection" | sed 's/\x0.*//')
    
    if [[ "$selection_clean" =~ ^[A-Za-z0-9] ]]; then
        # Es una aplicaciÃ³n instalada
        launch_app "$selection_clean"
    else
        # Es una opciÃ³n de herramientas
        case "$selection_clean" in
            *"Buscar aplicaciÃ³n"*) search_and_install ;;
            *"repositorios (pacman)"*) 
                term=$(echo "" | wofi --dmenu --prompt="Buscar en pacman: " --width=300 --cache-file=/dev/null)
                [[ -n "$term" ]] && search_pacman "$term"
                ;;
            *"AUR (yay)"*) 
                term=$(echo "" | wofi --dmenu --prompt="Buscar en AUR: " --width=300 --cache-file=/dev/null)
                [[ -n "$term" ]] && search_aur "$term"
                ;;
            *"Apps populares"*) popular_apps ;;
            *"Abrir terminal"*) kitty & ;;
            *"comando personalizado"*)
                cmd=$(echo "" | wofi --dmenu --prompt="Ejecutar comando: " --width=400 --cache-file=/dev/null)
                [[ -n "$cmd" ]] && eval "$cmd" &
                ;;
            *"GestiÃ³n de paquetes"*) package_management ;;
        esac
    fi
    
    # Limpiar archivos temporales
    rm -f "$list_file"
}

# Ejecutar funciÃ³n principal
main
